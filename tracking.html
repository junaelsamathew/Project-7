<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Tracking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --bg:#f8fafc; --text:#1a202c; --panel:#ffffff; --ring:#e2e8f0 }
    .dark :root, .dark { --bg:#0f172a; --text:#e5e7eb; --panel:#0b1220; --ring:#1f2937 }
    body { background: var(--bg); color: var(--text); }
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
      color: #1a202c;
      line-height: 1.6;
    }
    
    a {
      text-decoration: none;
      color: #f97316;
    }
    
    .container {
      max-width: 1100px;
      margin: 30px auto;
      background-color: var(--panel);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    header {
      background: var(--panel);
      padding: 15px 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      margin: -20px -30px 30px -30px;
      border-radius: 12px 12px 0 0;
    }
    
    header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      color: #1e293b;
      font-size: 1.3rem;
      user-select: none;
    }
    
    header .logo img {
      height: 36px;
      width: 36px;
    }
    
    header .nav-right {
      display: flex;
      gap: 25px;
      align-items: center;
      font-weight: 500;
    }
    
    header .nav-right a {
      cursor: pointer;
      color: #475569;
      transition: color 0.2s;
    }
    
    header .nav-right a:hover {
      color: #f97316;
    }
    
    .help-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #f97316;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .help-btn:hover {
      background: #ea580c;
      color: white;
      transform: translateY(-1px);
    }
    
    .order-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .order-id {
      font-weight: 700;
      color: #1e293b;
      font-size: 1.2rem;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .status-confirmed { background: #ecfdf5; color: #065f46; }
    .status-preparing { background: #fef3c7; color: #92400e; }
    .status-out-for-delivery { background: #dbeafe; color: #1e40af; }
    .status-delivered { background: #d1fae5; color: #065f46; }
    .status-received { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    
    .tracking-steps {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .step-tracker {
      display: flex;
      align-items: center;
      position: relative;
    }
    
    .step-tracker:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 14px;
      top: 30px;
      right: 14px;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
    }
    
    .step-circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      position: relative;
      z-index: 2;
      background: #e2e8f0;
      color: #64748b;
    }
    
    .step-circle.completed {
      background: #10b981;
      color: white;
    }
    
    .step-circle.current {
      background: #f97316;
      color: white;
    }
    
    .step-circle.cancelled {
      background: #ef4444;
      color: white;
    }
    
    .step-content {
      flex: 1;
      margin-left: 20px;
      padding: 10px 0;
    }
    
    .step-title {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 5px;
    }
    
    .step-time {
      color: #64748b;
      font-size: 0.9rem;
    }
    
    .order-summary {
      background: var(--panel);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }
    
    .section-heading {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .food-item {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .food-item img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      background: #f1f5f9;
    }
    
    .food-details {
      flex-grow: 1;
    }
    
    .food-title {
      font-weight: 700;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      color: #1e293b;
    }
    
    .food-location {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .quantity {
      color: #10b981;
      font-weight: 600;
    }
    
    .price {
      margin-left: auto;
      font-weight: 700;
      font-size: 1.1rem;
      color: #1a202c;
    }
    
    .bill-details {
      font-size: 0.95rem;
      margin-top: 15px;
    }
    
    .bill-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: #475569;
      padding: 5px 0;
    }
    
    .bill-row.total {
      font-weight: 800;
      font-size: 1.2rem;
      color: #1e293b;
      border-top: 2px solid #e2e8f0;
      padding-top: 15px;
      margin-top: 10px;
    }
    
    .address-section {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .address-details {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .address-icon {
      color: #f97316;
      font-size: 1.2rem;
      margin-top: 2px;
    }
    
    .address-text {
      flex: 1;
    }
    
    .address-name {
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }
    
    .address-line {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 3px;
    }
    
    .delivery-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .delivery-time {
      font-weight: 600;
      color: #10b981;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-primary {
      background: #f97316;
      color: white;
    }
    
    .btn-primary:hover {
      background: #ea580c;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #64748b;
    }
    
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .cancel-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .cancel-modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .cancel-reason {
      display: none;
      margin-top: 20px;
      text-align: left;
    }
    
    .cancel-reason.active {
      display: block;
    }
    
    .reason-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .reason-option:hover {
      border-color: #f97316;
      background: #fff7ed;
    }
    
    .reason-option.selected {
      border-color: #f97316;
      background: #fff7ed;
    }
    
    .reason-option input[type="radio"] {
      margin: 0;
      accent-color: #f97316;
    }
    
    .reason-option label {
      cursor: pointer;
      flex: 1;
      font-size: 0.95rem;
    }
    
    .cancel-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .confirmation-message {
      margin: 20px 0;
      padding: 15px;
      background: #ecfdf5;
      border-radius: 8px;
      color: #065f46;
      border-left: 4px solid #10b981;
    }
    
    .cancelled-message {
      margin: 20px 0;
      padding: 15px;
      background: #fee2e2;
      border-radius: 8px;
      color: #991b1b;
      border-left: 4px solid #ef4444;
      text-align: center;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .feature-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .feature-badge {
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .coupon-badge {
      background: #ecfdf5;
      color: #065f46;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <button id="dmBtn" style="position:fixed;top:12px;right:12px;z-index:50;background:#f97316;color:#fff;border:none;border-radius:9999px;width:40px;height:40px;cursor:pointer">ðŸŒ“</button>
  <header>
    <div class="logo">
      <img src="https://cdn-icons-png.flaticon.com/512/2838/2838912.png" alt="logo"/>
      <a href="index.html" style="color:#1e293b; text-decoration:none;">ORDER TRACKING</a>
    </div>
    <nav class="nav-right">
      <a href="help.html" class="help-btn">
        <i class="fas fa-question-circle"></i>
        Help
      </a>
      <a href="my acc.html">User</a>
    </nav>
  </header>

  <main class="container">
    <div id="emptyState" class="empty-state" style="display: none;">
      <i class="fas fa-inbox"></i>
      <h3>No Orders Yet</h3>
      <p>Track your recent orders here. Start by placing an order!</p>
      <a href="index.html" class="btn btn-primary">Browse Restaurants</a>
    </div>

    <div id="orderContent" style="display: none;">
      <div class="order-header">
        <div class="order-id">
          <i class="fas fa-hashtag"></i> Order #<span id="orderId"></span>
        </div>
        <div class="status-badge" id="orderStatusBadge">Confirmed</div>
      </div>

      <div class="delivery-info">
        <div>
          <div style="color: #64748b; font-size: 0.9rem;">Estimated Delivery</div>
          <div class="delivery-time" id="estimatedDelivery"></div>
        </div>
        <div id="deliveryIcon" style="font-size: 2rem; color: #10b981;">
          <i class="fas fa-bicycle"></i>
        </div>
      </div>

      <div class="tracking-steps">
        <div class="step-tracker">
          <div class="step-circle completed">
            <i class="fas fa-check"></i>
          </div>
          <div class="step-content">
            <div class="step-title">Order Confirmed</div>
            <div class="step-time" id="confirmedTime"></div>
          </div>
        </div>
        <div class="step-tracker">
          <div class="step-circle" id="preparingCircle">
            <i class="fas fa-utensils"></i>
          </div>
          <div class="step-content">
            <div class="step-title">Preparing Food</div>
            <div class="step-time" id="preparingTime"></div>
          </div>
        </div>
        <div class="step-tracker">
          <div class="step-circle" id="outCircle">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <div class="step-content">
            <div class="step-title">Out for Delivery</div>
            <div class="step-time" id="outTime"></div>
          </div>
        </div>
        <div class="step-tracker">
          <div class="step-circle" id="deliveredCircle">
            <i class="fas fa-home"></i>
          </div>
          <div class="step-content">
            <div class="step-title">Delivered</div>
            <div class="step-time" id="deliveredTime"></div>
          </div>
        </div>
      </div>

      <div class="address-section">
        <div class="address-details">
          <div class="address-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="address-text">
            <div class="address-name" id="addressName"></div>
            <div class="address-line" id="addressStreet"></div>
            <div class="address-line" id="addressCity"></div>
            <div class="address-line" id="addressPhone"></div>
          </div>
        </div>
      </div>

      <div class="order-summary">
        <div class="section-heading">Order Summary</div>
        <div id="orderItems"></div>
        <div class="feature-badges" id="orderFeatures"></div>
        <div class="coupon-badge" id="orderCoupon" style="display: none;"></div>
        <div class="bill-details" id="orderBill"></div>
      </div>

      <div class="action-buttons">
        <button id="markReceived" class="btn btn-success" style="display: none;">Mark as Received</button>
        <button id="cancelOrderBtn" class="btn btn-danger" style="display: none;">Cancel Order</button>
        <a href="index.html" class="btn btn-secondary">Order More</a>
      </div>
      <div id="cancelledMessage" class="cancelled-message" style="display: none;">
        <i class="fas fa-times-circle"></i> Order Cancelled Successfully! Reason: <span id="cancelReason"></span><br>Refund will be processed within 2-3 days. Redirecting to home...
      </div>
    </div>
  </main>

  <div class="cancel-modal" id="cancelModal">
    <div class="cancel-modal-content">
      <h2 style="color: #1e293b; margin-bottom: 15px;">Cancel Order?</h2>
      <p style="color: #64748b; margin-bottom: 20px;">Are you sure you want to cancel this order? You may be eligible for a refund.</p>
      <div id="cancelReasons" class="cancel-reason">
        <h3 style="color: #1e293b; margin-bottom: 15px;">Select a reason</h3>
        <div class="reason-option">
          <input type="radio" name="cancelReason" value="changed mind" id="changedMind">
          <label for="changedMind">Changed my mind</label>
        </div>
        <div class="reason-option">
          <input type="radio" name="cancelReason" value="wrong address" id="wrongAddress">
          <label for="wrongAddress">Wrong address entered</label>
        </div>
        <div class="reason-option">
          <input type="radio" name="cancelReason" value="long wait" id="longWait">
          <label for="longWait">Too long wait time</label>
        </div>
        <div class="reason-option">
          <input type="radio" name="cancelReason" value="other" id="other">
          <label for="other">Other</label>
        </div>
      </div>
      <div class="cancel-buttons">
        <button type="button" class="btn btn-secondary" id="confirmCancel">Yes, Cancel</button>
        <button type="button" class="btn btn-primary" id="closeCancel">No, Keep Order</button>
      </div>
    </div>
  </div>

  <script>
    // Dark mode
    (function(){
      const saved = localStorage.getItem('theme');
      if(saved === 'dark') document.documentElement.classList.add('dark');
      document.getElementById('dmBtn').addEventListener('click', ()=>{
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      });
    })();

    document.addEventListener('DOMContentLoaded', function() {
      // Set user name in header if available
      (function(){
        const nav = document.querySelector('nav.nav-right a[href="my acc.html"]');
        const savedName = localStorage.getItem('userName');
        if (nav && savedName && savedName.trim()) nav.textContent = savedName;
      })();

      function getOrders() { try { return JSON.parse(localStorage.getItem('orders') || '[]'); } catch { return []; } }

      const orders = getOrders();
      if (orders.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      // Get the latest order (first in array as per unshift in checkout)
      const latestOrder = orders[0];

      // Simulate status progression based on time (for demo; in real app, use server updates)
      const now = new Date();
      const orderTime = new Date(latestOrder.timestamp);
      const estimatedDelivery = new Date(latestOrder.estimatedDelivery);
      const timeElapsed = now - orderTime;

      let status = latestOrder.status || 'confirmed';
      let preparingTime = '';
      let outTime = '';
      let deliveredTime = '';
      let received = false;

      if (status === 'cancelled') {
        // Handle cancelled status
      } else if (timeElapsed > 10 * 60000) { // 10 min after order: preparing
        status = 'preparing';
        preparingTime = new Date(orderTime.getTime() + 10 * 60000).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
      }
      if (timeElapsed > 25 * 60000) { // 25 min: out for delivery
        status = 'out-for-delivery';
        outTime = new Date(orderTime.getTime() + 25 * 60000).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
      }
      if (now > estimatedDelivery) { // After estimated: delivered
        status = 'delivered';
        deliveredTime = estimatedDelivery.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        if (latestOrder.isReceived !== true) { // Assume received if past delivery + 5 min
          if (now > new Date(estimatedDelivery.getTime() + 5 * 60000)) {
            received = true;
            latestOrder.isReceived = true;
            localStorage.setItem('orders', JSON.stringify(orders)); // Persist received status
          }
        } else {
          received = true;
        }
        if (received) status = 'received';
      }

      // Update status in order
      latestOrder.status = status;
      localStorage.setItem('orders', JSON.stringify(orders));

      // Display order info
      document.getElementById('orderId').textContent = latestOrder.id.slice(3);
      document.getElementById('estimatedDelivery').textContent = latestOrder.scheduledDateTimeReadable || '43 mins';
      document.getElementById('confirmedTime').textContent = orderTime.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('preparingTime').textContent = preparingTime || '--:--';
      document.getElementById('outTime').textContent = outTime || '--:--';
      document.getElementById('deliveredTime').textContent = deliveredTime || '--:--';

      // Address
      const addr = latestOrder.address;
      document.getElementById('addressName').textContent = addr.name;
      document.getElementById('addressStreet').textContent = addr.street + (addr.landmark ? `, ${addr.landmark}` : '');
      document.getElementById('addressCity').textContent = `${addr.city}, ${addr.pincode}`;
      document.getElementById('addressPhone').textContent = `Phone: ${addr.phone}`;

      // Status badge and steps
      const badge = document.getElementById('orderStatusBadge');
      const preparingCircle = document.getElementById('preparingCircle');
      const outCircle = document.getElementById('outCircle');
      const deliveredCircle = document.getElementById('deliveredCircle');
      badge.textContent = status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');
      badge.className = `status-badge status-${status}`;

      if (status === 'cancelled') {
        // Special handling for cancelled
        preparingCircle.classList.remove('completed', 'current');
        outCircle.classList.remove('completed', 'current');
        deliveredCircle.classList.remove('completed', 'current');
        document.getElementById('deliveryIcon').innerHTML = '<i class="fas fa-times-circle" style="color: #ef4444;"></i>';
        document.getElementById('cancelledMessage').style.display = 'block';
        document.getElementById('cancelReason').textContent = latestOrder.cancelReason || 'Not specified';
        // Hide actions
        document.getElementById('cancelOrderBtn').style.display = 'none';
        document.getElementById('markReceived').style.display = 'none';
        // Redirect after 3 seconds
        setTimeout(() => { window.location.href = 'index.html'; }, 3000);
      } else if (status === 'confirmed') {
        preparingCircle.classList.add('current');
      } else if (status === 'preparing') {
        preparingCircle.classList.add('completed');
        outCircle.classList.add('current');
      } else if (status === 'out-for-delivery') {
        preparingCircle.classList.add('completed');
        outCircle.classList.add('completed');
        deliveredCircle.classList.add('current');
      } else if (status === 'delivered' || status === 'received') {
        preparingCircle.classList.add('completed');
        outCircle.classList.add('completed');
        deliveredCircle.classList.add('completed');
        if (status === 'received') {
          document.getElementById('deliveryIcon').innerHTML = '<i class="fas fa-check-circle"></i>';
        }
      }

      // Render items
      const itemsContainer = document.getElementById('orderItems');
      let itemTotal = 0;
      latestOrder.items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'food-item';
        row.innerHTML = `
          <img src="${item.image || 'pay.avif'}" alt="${item.title}">
          <div class="food-details">
            <div class="food-title">${item.title}</div>
            <div class="food-location">${item.badge || ''} â€¢ ${item.timeNote || ''}</div>
            <div style="color: #10b981; font-weight: 600;">Qty: ${item.qty || 1}</div>
            <div class="price">â‚¹${item.price * (item.qty || 1)}</div>
          </div>
        `;
        itemsContainer.appendChild(row);
        itemTotal += item.price * (item.qty || 1);
      });

      // Features
      const featuresContainer = document.getElementById('orderFeatures');
      if (latestOrder.orderFeatures.ecoPacking) {
        const badge = document.createElement('div');
        badge.className = 'feature-badge';
        badge.textContent = 'Eco Packing';
        featuresContainer.appendChild(badge);
      }
      if (latestOrder.orderFeatures.giftCard) {
        const badge = document.createElement('div');
        badge.className = 'feature-badge';
        badge.textContent = `Gift Card: ${latestOrder.orderFeatures.giftCardDesign}`;
        featuresContainer.appendChild(badge);
      }
      if (latestOrder.orderFeatures.splitBill) {
        const badge = document.createElement('div');
        badge.className = 'feature-badge';
        badge.textContent = `Split Bill (${latestOrder.orderFeatures.splitBillCount} people)`;
        featuresContainer.appendChild(badge);
      }

      // Coupon
      if (latestOrder.appliedCoupon) {
        const couponEl = document.getElementById('orderCoupon');
        couponEl.textContent = `${latestOrder.appliedCoupon.code} Applied`;
        couponEl.style.display = 'block';
      }

      // Bill details (reconstruct from stored data)
      let featuresCost = 0;
      if (latestOrder.orderFeatures.ecoPacking) featuresCost += 5;
      if (latestOrder.orderFeatures.giftCard) featuresCost += 25;
      const subtotal = itemTotal + featuresCost;
      let deliveryFee = latestOrder.items.length ? 48 : 0;
      let discountAmount = 0;
      if (latestOrder.appliedCoupon) {
        if (latestOrder.appliedCoupon.type === 'percentage') {
          discountAmount = Math.min((subtotal * latestOrder.appliedCoupon.discount / 100), latestOrder.appliedCoupon.max || Infinity);
        } else if (latestOrder.appliedCoupon.type === 'fixed') {
          discountAmount = latestOrder.appliedCoupon.discount;
        } else if (latestOrder.appliedCoupon.type === 'delivery') {
          discountAmount = deliveryFee;
          deliveryFee = 0;
        }
      }
      const taxableAmount = subtotal - discountAmount + deliveryFee;
      const gst = Math.round(taxableAmount * 0.18);
      const codCharge = (latestOrder.paymentMethod === 'cod') ? 10 : 0;
      const total = taxableAmount + gst + codCharge;

      document.getElementById('orderBill').innerHTML = `
        <div class="bill-row"><span>Item Total</span> <span>â‚¹${itemTotal}</span></div>
        <div class="bill-row"><span>Delivery Fee</span> <span>â‚¹${deliveryFee}</span></div>
        ${discountAmount > 0 ? `<div class="bill-row" style="color: #10b981;"><span>Discount</span> <span>-â‚¹${Math.round(discountAmount)}</span></div>` : ''}
        ${featuresCost > 0 ? `<div class="bill-row"><span>Order Features</span> <span>+â‚¹${featuresCost}</span></div>` : ''}
        <div class="bill-row"><span>GST (18%)</span> <span>â‚¹${gst}</span></div>
        ${codCharge > 0 ? `<div class="bill-row"><span>COD Charge</span> <span>â‚¹${codCharge}</span></div>` : ''}
        <div class="bill-row total"><span>Total Paid</span> <span>â‚¹${total}</span></div>
      `;

      // Actions
      const cancelBtn = document.getElementById('cancelOrderBtn');
      const markReceivedBtn = document.getElementById('markReceived');
      const cancelModal = document.getElementById('cancelModal');

      if (status === 'confirmed' || status === 'preparing') {
        cancelBtn.style.display = 'inline-block';
      }
      if (status === 'delivered' && !received) {
        markReceivedBtn.style.display = 'inline-block';
      }

      cancelBtn.addEventListener('click', () => {
        cancelModal.style.display = 'flex';
        document.getElementById('cancelReasons').classList.add('active');
        document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
      });

      document.getElementById('closeCancel').addEventListener('click', () => {
        cancelModal.style.display = 'none';
        document.getElementById('cancelReasons').classList.remove('active');
        document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
      });

      document.querySelectorAll('.reason-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
        });
      });

      document.getElementById('confirmCancel').addEventListener('click', () => {
        const selectedReason = document.querySelector('input[name="cancelReason"]:checked');
        if (!selectedReason) {
          alert('Please select a reason for cancellation.');
          return;
        }
        latestOrder.status = 'cancelled';
        latestOrder.cancelReason = selectedReason.value;
        localStorage.setItem('orders', JSON.stringify(orders));
        
        // Update UI in place for cancelled
        status = 'cancelled';
        badge.textContent = 'Cancelled';
        badge.className = `status-badge status-cancelled`;
        preparingCircle.classList.remove('completed', 'current');
        outCircle.classList.remove('completed', 'current');
        deliveredCircle.classList.remove('completed', 'current');
        deliveredCircle.classList.add('cancelled');
        document.getElementById('deliveryIcon').innerHTML = '<i class="fas fa-times-circle" style="color: #ef4444;"></i>';
        document.getElementById('cancelledMessage').style.display = 'block';
        document.getElementById('cancelReason').textContent = selectedReason.value;
        cancelBtn.style.display = 'none';
        markReceivedBtn.style.display = 'none';
        cancelModal.style.display = 'none';
        
        // Redirect to home after 3 seconds
        setTimeout(() => { window.location.href = 'index.html'; }, 3000);
      });

      markReceivedBtn.addEventListener('click', () => {
        latestOrder.isReceived = true;
        latestOrder.status = 'received';
        localStorage.setItem('orders', JSON.stringify(orders));
        alert('Order marked as received. Enjoy your meal!');
        location.reload();
      });

      document.getElementById('orderContent').style.display = 'block';
    });
  </script>
</body>
</html>
